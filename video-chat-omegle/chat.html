<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Stranger Chat</title>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        height: 100vh;
        display: flex;
        background: #f2f2f2;
    }

    .container {
        display: flex;
        width: 100%;
        height: 100%;
    }

    /* ===== VIDEO AREA ===== */
    .left-col {
        flex: 2;
        position: relative;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none;
    }

    .spinner {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        border: 4px solid #fff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: none;
        z-index: 20;
    }

    @keyframes spin {
        from { transform: translate(-50%, -50%) rotate(0deg); }
        to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    #micBtn {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 55px;
        height: 55px;
        border-radius: 50%;
        background: #3498ff;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
    }

    /* ===== CHAT AREA ===== */
    .right-col {
        flex: 1;
        background: white;
        display: flex;
        flex-direction: column;
        border-left: 2px solid #ddd;
    }

    #status {
        padding: 10px;
        text-align: center;
        background: #fff;
        font-size: 16px;
        color: #444;
        border-bottom: 1px solid #ddd;
    }

    #chatMessages {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        background: #fafafa;
    }

    .message {
        padding: 8px 12px;
        border-radius: 8px;
        margin-bottom: 6px;
        font-size: 14px;
        max-width: 80%;
    }

    .you {
        background: #d2e8ff;
        align-self: flex-end;
    }

    .stranger {
        background: #e7e7e7;
        align-self: flex-start;
    }

    .system-message {
        text-align: center;
        font-size: 13px;
        color: #666;
        margin: 10px 0;
    }

    .chat-input-row {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ddd;
        align-items: center;
        gap: 6px;
    }

    .chat-btn {
        background:#3498ff;
        color:white;
        border:none;
        padding:8px 12px;
        border-radius:6px;
        cursor:pointer;
        font-size:14px;
    }

    .chat-btn.stop {
        background:#ff3b3b;
    }

    #chatInput {
        flex: 1;
        padding:10px;
        border:1px solid #ccc;
        border-radius:6px;
        font-size:14px;
    }

    #sendBtn {
        background:#2ecc71;
        border:none;
        padding:8px 12px;
        border-radius:6px;
        color:white;
        cursor:pointer;
    }
</style>
</head>
<body>

<div class="container">

    <!-- LEFT: VIDEO -->
    <div class="left-col">
        <video id="localVideo" autoplay muted></video>
        <video id="remoteVideo" autoplay></video>

        <div id="localSpinner" class="spinner"></div>
        <div id="remoteSpinner" class="spinner"></div>

        <button id="micBtn">ðŸŽ¤</button>
    </div>

    <!-- RIGHT: CHAT -->
    <div class="right-col">
        <div id="status">Ready</div>

        <div id="chatMessages"></div>

        <div class="chat-input-row">
            <button id="startBtn" class="chat-btn">Start</button>
            <button id="skipBtn" class="chat-btn">Skip</button>
            <button id="stopBtn" class="chat-btn stop">Stop</button>

            <input id="chatInput" placeholder="Type a message..." disabled>
            <button id="sendBtn" disabled>Send</button>
        </div>
    </div>

</div>

<!-- SOCKET.IO -->
<script src="/socket.io/socket.io.js"></script>

<!-- SCRIPT.JS ÙƒØ§Ù…Ù„ (Ø§Ù„Ø°ÙŠ Ø£Ø¹Ø·ÙŠØªÙ†ÙŠ Ø¥ÙŠØ§Ù‡) -->
<script>
/* â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
   Ø³ÙƒØ±Ø¨ØªÙƒ ÙƒØ§Ù…Ù„ + Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” */

const socket = io();
let localStream = null;
let peerConnection = null;
let partnerId = null;
let isInitiator = false;
let autoReconnect = true;
let isStopped = false;
let micEnabled = true;

const servers = { iceServers: [{ urls: ["stun:stun.l.google.com:19302"] }] };

// DOM
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const localSpinner = document.getElementById("localSpinner");
const remoteSpinner = document.getElementById("remoteSpinner");
const statusText = document.getElementById("status");
const startBtn = document.getElementById("startBtn");
const skipBtn = document.getElementById("skipBtn");
const stopBtn = document.getElementById("stopBtn");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const chatMessages = document.getElementById("chatMessages");
const micBtn = document.getElementById("micBtn");

/* ========= MIC BUTTON ========= */
function updateMicButton() {
    if (!micBtn) return;
    micBtn.innerHTML = micEnabled ? "ðŸŽ¤" : "ðŸ”‡";
}

function toggleMicrophone() {
    if (!localStream) return;
    micEnabled = !micEnabled;
    localStream.getAudioTracks().forEach(t => t.enabled = micEnabled);
    updateMicButton();
}
window.toggleMicrophone = toggleMicrophone;
micBtn.onclick = toggleMicrophone;

window.setLocalStream = function(stream) {
    localStream = stream;
    micBtn.style.display = "flex";
    updateMicButton();
};

/* ========= UI ========= */
function showSpinners() {
    localSpinner.style.display = "block";
    remoteSpinner.style.display = "block";
    localVideo.style.display = "none";
    remoteVideo.style.display = "none";
}

function hideSpinners() {
    localSpinner.style.display = "none";
    remoteSpinner.style.display = "none";
    localVideo.style.display = "block";
    remoteVideo.style.display = "block";
}

function showRemoteSpinner() {
    remoteSpinner.style.display = "block";
    remoteVideo.style.display = "none";
}

function hideRemoteSpinner() {
    remoteSpinner.style.display = "none";
    remoteVideo.style.display = "block";
}

function addMessage(msg, type="system") {
    const div = document.createElement("div");
    div.className = type === "system" ? "system-message" : "message " + type;
    div.textContent = msg;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function enableChat() {
    chatInput.disabled = false;
    sendBtn.disabled = false;
}

function disableChat() {
    chatInput.disabled = true;
    sendBtn.disabled = true;
    chatInput.value = "";
}

/* ========= MEDIA ========= */
async function initMedia() {
    if (!localStream) {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;
            window.setLocalStream(localStream);
        } catch {
            statusText.textContent = "Camera/mic access denied.";
            return false;
        }
    }
    return true;
}

/* ========= SEARCH LOOP ========= */
let searchTimer = null;
let pauseTimer = null;

function startSearchLoop() {
    if (isStopped || partnerId) return;
    showRemoteSpinner();
    socket.emit("find-partner");
    statusText.textContent = "Searching for stranger...";

    searchTimer = setTimeout(() => {
        if (!partnerId && !isStopped) {
            socket.emit("stop");
            hideRemoteSpinner();
            statusText.textContent = "Pausing search...";
            pauseTimer = setTimeout(startSearchLoop, 2000);
        }
    }, 4000);
}

async function startSearch() {
    if (!(await initMedia())) return;

    closePeerConnection();
    partnerId = null;
    isInitiator = false;
    chatMessages.innerHTML = "";
    showRemoteSpinner();

    statusText.textContent = "Searching...";
    skipBtn.disabled = false;
    stopBtn.disabled = false;
    startBtn.disabled = true;

    startSearchLoop();
}

/* ========= BUTTONS ========= */
startBtn.onclick = () => {
    isStopped = false;
    autoReconnect = true;
    startSearch();
};

skipBtn.onclick = () => {
    statusText.textContent = "Skipping...";
    clearTimeout(searchTimer);
    clearTimeout(pauseTimer);
    socket.emit("skip");
    closePeerConnection();
    disableChat();
    addMessage("You skipped the stranger.", "system");
    showRemoteSpinner();
    startSearchLoop();
};

stopBtn.onclick = () => {
    statusText.textContent = "Stopped.";
    isStopped = true;
    autoReconnect = false;

    clearTimeout(searchTimer);
    clearTimeout(pauseTimer);
    socket.emit("stop");
    closePeerConnection();
    disableChat();

    addMessage("Disconnected.", "system");

    startBtn.disabled = false;
    skipBtn.disabled = true;
    stopBtn.disabled = true;

    if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
        localStream = null;
        micBtn.style.display = "none";
    }

    localVideo.srcObject = null;
    remoteVideo.srcObject = null;
};

/* ========= CHAT ========= */
sendBtn.onclick = sendMessage;
chatInput.onkeypress = e => { if (e.key === "Enter") sendMessage(); };

function sendMessage() {
    const msg = chatInput.value.trim();
    if (!msg || !partnerId) return;

    addMessage(msg, "you");
    socket.emit("chat-message", { to: partnerId, message: msg });
    chatInput.value = "";
}

/* ========= SOCKET EVENTS ========= */
socket.on("waiting", msg => {
    statusText.textContent = msg || "Waiting...";
});

socket.on("chat-message", ({ message }) => {
    addMessage(message, "stranger");
});

socket.on("partner-found", async payload => {
    clearTimeout(searchTimer);
    clearTimeout(pauseTimer);

    partnerId = payload.id;
    isInitiator = !!payload.initiator;
    statusText.textContent = "Stranger found! Connecting...";

    hideSpinners();
    createPeerConnection();

    if (isInitiator) {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit("signal", { to: partnerId, data: peerConnection.localDescription });
    }
});

socket.on("signal", async ({ from, data }) => {
    if (!peerConnection) createPeerConnection();

    if (data.type === "offer") {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        socket.emit("signal", { to: from, data: peerConnection.localDescription });
    }
    else if (data.type === "answer") {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data));
    }
    else if (data.candidate) {
        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
    }
});

socket.on("partner-disconnected", () => {
    statusText.textContent = "Stranger disconnected.";
    closePeerConnection();
    disableChat();
    addMessage("Stranger disconnected.", "system");

    partnerId = null;
    isInitiator = false;

    if (autoReconnect && !isStopped) {
        statusText.textContent = "Searching for new stranger...";
        showRemoteSpinner();
        startSearchLoop();
    } else {
        startBtn.disabled = false;
        skipBtn.disabled = true;
        stopBtn.disabled = true;
    }
});

/* ========= WEBRTC ========= */
function createPeerConnection() {
    peerConnection = new RTCPeerConnection(servers);

    if (localStream) {
        localStream.getTracks().forEach(track =>
            peerConnection.addTrack(track, localStream)
        );
    }

    peerConnection.ontrack = e => {
        remoteVideo.srcObject = e.streams[0];
        hideRemoteSpinner();
        enableChat();
        addMessage("Connected! Say hi ðŸ‘‹", "system");
        remoteVideo.style.display = "block";
        localVideo.style.display = "block";
    };

    peerConnection.onicecandidate = e => {
        if (e.candidate && partnerId) {
            socket.emit("signal", { to: partnerId, data: { candidate: e.candidate } });
        }
    };

    peerConnection.onconnectionstatechange = () => {
        if (!peerConnection) return;
        const s = peerConnection.connectionState;

        if (s === "connected") {
            statusText.textContent = "Connected!";
        }
        
        if (["failed","disconnected","closed"].includes(s)) {
            statusText.textContent = "Connection lost.";
            closePeerConnection();
            disableChat();
            addMessage("Connection lost.", "system");

            if (autoReconnect && !isStopped) {
                statusText.textContent = "Reconnecting...";
                showRemoteSpinner();
                startSearchLoop();
            }
        }
    };
}

function closePeerConnection() {
    try {
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
    } catch {}
    remoteVideo.srcObject = null;
}
</script>

</body>
</html>
