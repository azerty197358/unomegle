<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SparkChat â€” Omegle-like UI</title>

  <style>
    :root{
      --blue:#2ea3ff;
      --accent:#ff9a00;
      --bg:#fafbfd;
      --panel:#ffffff;
      --dark-panel:#0f1115;
      --text:#0b1220;
      --muted:#9aa4ad;
      --border:#e7e9ec;
      --radius:12px;
      --gap:12px;
    }
    .dark{
      --bg:#0b0d10;
      --panel:#111316;
      --text:#eef2f5;
      --muted:#9aa4ad;
      --border:#272a2f;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family: "Segoe UI", Tahoma, Arial, sans-serif;background:var(--bg);color:var(--text);overflow:hidden}

    /* Topbar */
    .topbar{
      height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 18px;
      background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.4));
      border-bottom:1px solid var(--border);
      gap:12px;
    }
    .topbar .left{display:flex;align-items:center;gap:20px}
    .logo{
      font-weight:800;font-size:28px;color:var(--accent);display:flex;gap:4px;align-items:center;user-select:none;
    }
    .logo span{display:inline-block;transition:transform .45s ease}
    .logo .logo-chat{color:#3fa0ff}

    .top-actions{display:flex;gap:10px;align-items:center}
    .icon-btn{background:transparent;border:none;cursor:pointer;padding:8px;border-radius:8px;font-size:18px}
    #darkToggle{background:transparent}
    #exitBtn{background:#ff5454;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}

    /* Stage */
    .stage{position:absolute;left:0;right:0;top:64px;bottom:0;padding:18px;display:flex;gap:var(--gap);align-items:stretch}
    .left-col{width:360px;min-width:260px;display:flex;flex-direction:column;gap:12px}
    .right-col{flex:1;display:flex;flex-direction:column;gap:12px}

    /* video frames */
    .video-frame{
      border-radius:12px;overflow:hidden;background:#000;border:6px solid var(--border);position:relative;min-height:1px;
      display:flex;align-items:center;justify-content:center;
    }
    .video-frame.top{height:320px}
    .video-frame.bottom{height:220px}

    video{width:100%;height:100%;object-fit:cover;display:block;background:#000}
    .watermark{position:absolute;left:12px;bottom:12px;color:#fff;font-weight:700;opacity:.9}
    .video-label{position:absolute;top:12px;left:12px;background:rgba(255,255,255,0.95);padding:6px 10px;border-radius:8px;font-weight:600;color:#111}
    .spinner{position:absolute;width:60px;height:60px;border-radius:50%;border:6px solid #fff;border-top-color:transparent;animation:spin 1s linear infinite;z-index:20}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

    /* small circular buttons overlay */
    .overlay-btn{position:absolute;right:12px;bottom:12px;background:var(--blue);color:#fff;border:none;border-radius:50%;width:48px;height:48px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;z-index:30;box-shadow:0 6px 18px rgba(0,0,0,0.15)}
    .report-btn{position:absolute;top:12px;right:12px;background:#ff4343;color:#fff;padding:6px 10px;border-radius:8px;border:none;z-index:30;cursor:pointer;font-weight:700}

    /* chat panel */
    .chat-panel{background:var(--panel);border-radius:12px;border:6px solid var(--border);display:flex;flex-direction:column;min-width:200px;overflow:hidden}
    .chat-area{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;background:transparent}
    .msg{max-width:78%;padding:10px 14px;border-radius:12px;font-size:14px;line-height:1.25}
    .msg.system{align-self:center;background:rgba(0,0,0,0.04);color:var(--muted)}
    .msg.you{align-self:flex-end;background:rgba(46,163,255,0.12);border:1px solid rgba(46,163,255,0.25)}
    .msg.stranger{align-self:flex-start;background:rgba(255,216,176,0.14);border:1px solid rgba(255,182,105,0.22)}

    .chat-input-row{padding:12px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:10px;background:linear-gradient(0deg, rgba(255,255,255,0.65), rgba(255,255,255,0.45))}
    .status{padding:8px 10px;border-radius:8px;background:transparent;border:1px solid var(--border);text-align:center;color:var(--muted);font-size:13px}

    .input-row{display:flex;gap:10px;align-items:center}
    #chatInput{flex:1;padding:12px;border-radius:10px;border:1px solid var(--border);outline:none;font-size:15px;background:transparent}
    #skipBtn{background:linear-gradient(180deg,var(--blue),#1a8de0);color:#fff;padding:12px 18px;border-radius:8px;border:none;cursor:pointer;font-weight:700;box-shadow:0 10px 18px rgba(46,163,255,0.14)}
    #sendBtn{background:var(--blue);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}

    /* notification box */
    .notify-box{position:relative}
    #notifyDot{position:absolute;top:0;left:0;width:10px;height:10px;background:#ff3b30;border-radius:50%;display:none}

    #notifyMenu{position:absolute;left:0;top:46px;width:260px;background:var(--panel);border:1px solid var(--border);border-radius:10px;display:none;z-index:999;padding:8px;max-height:260px;overflow:auto}
    .notify-item{padding:8px;border-bottom:1px dashed var(--border);font-size:13px;color:var(--muted)}

    /* responsive */
    @media (max-width:900px){
      .stage{flex-direction:column;padding:10px}
      .left-col{width:100%;flex-direction:row;gap:10px}
      .video-frame.top{flex:1;height:220px;border-width:4px}
      .video-frame.bottom{flex:1;height:160px;border-width:4px}
      .right-col{order:3}
    }
    @media (max-width:600px){
      .left-col{flex-direction:column}
      .video-frame.top{height:280px}
      .video-frame.bottom{height:180px}
      #toggleMessagesBtn{display:block}
      .chat-panel{display:none}
      .messages-visible .chat-panel{display:flex}
    }

    /* little flip animation for logo letters */
    .flip{animation:flipAnim .6s cubic-bezier(.2,.9,.3,1) forwards}
    @keyframes flipAnim{0%{transform:rotateY(0) scale(1)}50%{transform:rotateY(180deg) scale(1.25)}100%{transform:rotateY(360deg) scale(1)}}

  </style>
</head>
<body>

  <div class="topbar">
    <div class="left">
      <div class="logo" id="logo">
        <span>S</span><span>p</span><span>a</span><span>r</span><span>k</span>
        <span class="logo-chat">C</span><span class="logo-chat">h</span><span class="logo-chat">a</span><span class="logo-chat">t</span>
      </div>
      <div style="color:var(--muted);font-size:14px">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø±Ø¦ÙŠØ©</div>
    </div>

    <div class="top-actions">
      <div class="notify-box" id="notifyBox" title="Notifications">
        <button class="icon-btn" id="notifyIcon">ðŸ””</button>
        <div id="notifyDot"></div>
        <div id="notifyMenu">
          <div class="notify-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>
        </div>
      </div>

      <button class="icon-btn" id="darkToggle" title="Dark / Light">ðŸŒ™</button>
      <button id="exitBtn" title="Exit">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div class="stage">

    <div class="left-col">
      <div class="video-frame top" id="remoteFrame">
        <button class="report-btn" id="reportBtn">ðŸš¨ Ø¨Ù„Ù‘Øº</button>
        <div class="video-label">Stranger</div>
        <div class="watermark">SparkChat</div>
        <div id="remoteSpinner" class="spinner"></div>
        <video id="remoteVideo" autoplay playsinline></video>
      </div>

      <div class="video-frame bottom" id="localFrame">
        <button class="overlay-btn" id="micBtn" title="Toggle Mic">ðŸŽ¤</button>
        <div class="video-label">You</div>
        <div class="watermark">SparkChat</div>
        <div id="localSpinner" class="spinner"></div>
        <video id="localVideo" autoplay muted playsinline></video>
      </div>
    </div>

    <button id="toggleMessagesBtn" style="display:none;align-self:flex-start;padding:8px 10px;border-radius:8px;background:var(--blue);color:#fff;border:none;cursor:pointer">â–¼</button>

    <div class="right-col">
      <div class="chat-panel" id="chatPanel">
        <div id="chatMessages" class="chat-area" dir="ltr">
          <div class="msg system">Connecting...</div>
        </div>

        <div class="chat-input-row">
          <div class="status" id="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

          <div class="input-row">
            <button id="skipBtn">Skip</button>
            <input id="chatInput" placeholder="Type a message..." autocomplete="off" />
            <button id="sendBtn">âž¤</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Optional: Socket.io (if your backend provides it) -->
  <script src="/socket.io/socket.io.js"></script>

  <script>
    /*******************************
     * UI behavior (complete)
     * - Dark mode toggle
     * - Logo flip animation
     * - Notifications menu
     * - Skip / Send basic handlers
     * - Mic toggle (visual + permission)
     * - Report confirmation
     * - Toggle messages (mobile)
     * - Local getUserMedia + simulated remote stream if none
     *******************************/

    // --- Dark mode
    const darkToggle = document.getElementById('darkToggle');
    darkToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      darkToggle.textContent = document.body.classList.contains('dark') ? 'â˜€ï¸' : 'ðŸŒ™';
    });

    // --- Logo flip animation (random letter every 3s)
    const logoLetters = document.querySelectorAll('#logo span');
    function flipRandom(){
      const idx = Math.floor(Math.random() * logoLetters.length);
      const el = logoLetters[idx];
      el.classList.add('flip');
      setTimeout(()=> el.classList.remove('flip'), 600);
    }
    setInterval(flipRandom, 3000);

    // --- Notifications
    const notifyIcon = document.getElementById('notifyIcon');
    const notifyMenu = document.getElementById('notifyMenu');
    const notifyDot = document.getElementById('notifyDot');
    const notifyBox = document.getElementById('notifyBox');
    notifyIcon.addEventListener('click', (e) => {
      e.stopPropagation();
      notifyMenu.style.display = notifyMenu.style.display === 'block' ? 'none' : 'block';
      notifyDot.style.display = 'none';
    });
    document.addEventListener('click', ()=> notifyMenu.style.display = 'none');

    // Example: show dot on load (demo)
    setTimeout(()=> notifyDot.style.display = 'block', 1200);

    // --- Report button
    const reportBtn = document.getElementById('reportBtn');
    reportBtn.addEventListener('click', ()=>{
      const ok = confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙØ¹Ù„Ø§Ù‹ØŸ');
      if(ok){
        // maintain existing ID for server integration: trigger an event (you can change)
        appendSystemMessage('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­.');
        // Here you could call your API or socket to report
      }
    });

    // --- Chat: append helpers
    const chatMessages = document.getElementById('chatMessages');
    function appendMessage(text, type='system'){
      const d = document.createElement('div');
      d.className = 'msg ' + (type==='system'? 'system' : (type==='you' ? 'you' : 'stranger'));
      d.textContent = text;
      chatMessages.appendChild(d);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function appendSystemMessage(txt){ appendMessage(txt,'system'); }
    function appendYouMessage(txt){ appendMessage(txt,'you'); }
    function appendStrangerMessage(txt){ appendMessage(txt,'stranger'); }

    // --- Skip button
    const skipBtn = document.getElementById('skipBtn');
    skipBtn.addEventListener('click', ()=> {
      appendSystemMessage('Skipping to the next user...');
      // simulate disconnection and reconnection
      simulateRemoteDisconnectThenReconnect();
      // If your backend expects an event, emit socket event here (keeping ID compat)
      // socket && socket.emit('skip');
    });

    // --- Send button + Enter key
    const sendBtn = document.getElementById('sendBtn');
    const chatInput = document.getElementById('chatInput');
    sendBtn.addEventListener('click', sendChat);
    chatInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter') sendChat();
    });
    function sendChat(){
      const txt = chatInput.value.trim();
      if(!txt) return;
      appendYouMessage(txt);
      chatInput.value = '';
      // If you have socket: socket.emit('message', txt);
      // For demo, auto-reply from stranger
      setTimeout(()=> appendStrangerMessage('Reply: ' + txt), 900);
    }

    // --- Mic toggle: request permission and toggle audio track
    const micBtn = document.getElementById('micBtn');
    let localStream = null;
    let micEnabled = true;
    micBtn.addEventListener('click', async ()=>{
      if(!localStream){
        await startLocalStream();
        return;
      }
      micEnabled = !micEnabled;
      localStream.getAudioTracks().forEach(t => t.enabled = micEnabled);
      micBtn.style.background = micEnabled ? 'var(--blue)' : '#888';
      micBtn.title = micEnabled ? 'Mic ON' : 'Mic OFF';
    });

    // --- Toggle messages button (mobile)
    const toggleMessagesBtn = document.getElementById('toggleMessagesBtn');
    toggleMessagesBtn.addEventListener('click', ()=>{
      document.body.classList.toggle('messages-visible');
      const panel = document.getElementById('chatPanel');
      panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
      toggleMessagesBtn.textContent = panel.style.display === 'flex' ? 'â–²' : 'â–¼';
    });

    // --- Video: get local stream and show; try to get remote via socket or simulate
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const localSpinner = document.getElementById('localSpinner');
    const remoteSpinner = document.getElementById('remoteSpinner');
    const statusBox = document.getElementById('status');

    async function startLocalStream(){
      try{
        localSpinner.style.display = 'block';
        const s = await navigator.mediaDevices.getUserMedia({video:{width:640}, audio:true});
        localStream = s;
        localVideo.srcObject = s;
        // start with mic enabled true
        localStream.getAudioTracks().forEach(t => t.enabled = micEnabled);
        localSpinner.style.display = 'none';
        statusBox.textContent = 'Connected (local ready)';
        // if you have signaling, you'd send this stream to peer here. For demo we simulate a remote
        simulateRemoteStream();
      }catch(err){
        localSpinner.style.display = 'none';
        statusBox.textContent = 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§/Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†';
        console.warn('getUserMedia error', err);
      }
    }

    // Simulate remote stream (for demo) â€” in real app remoteVideo should be set by your WebRTC/Socket handling
    function simulateRemoteStream(){
      // if browser supports captureStream from localVideo, reuse it with delay to mimic remote
      try{
        if(localVideo.captureStream){
          const simulated = localVideo.captureStream(25);
          setTimeout(()=> {
            remoteVideo.srcObject = simulated;
            remoteSpinner.style.display = 'none';
            statusBox.textContent = 'Connected to stranger';
            // add sample system message
            appendSystemMessage('You are now connected. Say hi!');
          }, 900);
        } else {
          // fallback: hide spinner and show black
          remoteSpinner.style.display = 'none';
          statusBox.textContent = 'Waiting for stranger...';
        }
      }catch(e){
        remoteSpinner.style.display = 'none';
        statusBox.textContent = 'Waiting for stranger...';
      }
    }

    // Simulate remote disconnect/reconnect
    function simulateRemoteDisconnectThenReconnect(){
      remoteSpinner.style.display = 'block';
      remoteVideo.srcObject = null;
      statusBox.textContent = 'Searching for next user...';
      setTimeout(()=> {
        // if local available, reuse as simulated remote
        if(localVideo.srcObject) {
          simulateRemoteStream();
        } else {
          remoteSpinner.style.display = 'none';
          statusBox.textContent = 'No camera available locally';
        }
      }, 1200);
    }

    // Auto start local stream for better demo UX
    // (Browsers require user gesture for autoplay with audio; video muted allows autoplay)
    (async ()=>{
      // Attempt to auto-start muted video (local) to show preview
      try{
        localSpinner.style.display = 'block';
        const s = await navigator.mediaDevices.getUserMedia({video:{width:640}, audio:false});
        localStream = s;
        localVideo.srcObject = s;
        localSpinner.style.display = 'none';
        statusBox.textContent = 'Preview ready (click mic to enable audio)';
        // keep audio disabled until user clicks mic â€” now request audio separately when mic toggled
      }catch(e){
        localSpinner.style.display = 'none';
        statusBox.textContent = 'ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…ØªØ§Ø­Ø©';
      }
    })();

    // --- Exit button (just for demo)
    document.getElementById('exitBtn').addEventListener('click', ()=>{
      if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©ØŸ')) {
        appendSystemMessage('ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬.');
        // If you have socket: socket.emit('leave');
        // Stop local tracks
        if(localStream){
          localStream.getTracks().forEach(t=>t.stop());
          localVideo.srcObject = null;
        }
        remoteVideo.srcObject = null;
        statusBox.textContent = 'Disconnected';
      }
    });

    // --- Ensure UI elements exist for integration with your existing script.js
    // If you already have a script.js that expects these IDs, this template preserves them:
    // IDs: localVideo, remoteVideo, skipBtn, micBtn, reportBtn, chatInput, sendBtn, chatMessages, status
    // So you can drop your existing script.js (that uses socket.io) and it will still find these DOM nodes.

    // --- Accessibility: focus input on load
    setTimeout(()=> {
      const input = document.getElementById('chatInput');
      if(input) input.focus();
    }, 900);

    // Example: Append a timed system message
    setTimeout(()=> appendSystemMessage('Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¬Ø§Ù‡Ø² â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªÙˆØµÙŠÙ„ ÙˆØ¸Ø§Ø¦ÙÙƒ Ø§Ù„Ø®Ù„ÙÙŠØ©.'), 1600);

    // --- Protect against missing socket.io (non-blocking)
    try{
      if(typeof io === 'function'){
        // If the developer has a backend socket, integrate here:
        const socket = io();
        // Example: listen to incoming chat messages
        socket.on('chat-message', (msg)=>{
          appendStrangerMessage(msg);
        });
        // Provide hooks for skip / report / send
        skipBtn.addEventListener('click', ()=> socket.emit('skip'));
        reportBtn.addEventListener('click', ()=> socket.emit('report'));
        sendBtn.addEventListener('click', ()=> {
          const txt = chatInput.value.trim();
          if(!txt) return;
          socket.emit('message', txt);
        });
        // and more â€” but do not assume these on the client when no socket provided
      }
    }catch(e){
      // no socket available â€” fine, our UI still works for demo
    }
  </script>
</body>
</html>
