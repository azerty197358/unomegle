<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Admin Panel â€” Live Dashboard</title>
<style>
  :root {
    --primary: #4b6cb7;
    --primary-dark: #182848;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --dark: #1e293b;
    --gray: #64748b;
    --light-gray: #f1f5f9;
    --white: #ffffff;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  }
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--light-gray) 0%, #e2e8f0 100%);
    padding: 20px;
    min-height: 100vh;
    color: var(--dark);
  }
  h1 {
    color: var(--primary-dark);
    margin-bottom: 24px;
    font-size: 28px;
    font-weight: 700;
  }
  .topbar {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 24px;
    background: var(--white);
    padding: 12px;
    border-radius: 12px;
    box-shadow: var(--shadow);
  }
  .tab {
    padding: 12px 20px;
    border-radius: 8px;
    background: var(--light-gray);
    cursor: pointer;
    border: none;
    transition: all 0.3s ease;
    font-weight: 600;
    color: var(--gray);
    position: relative;
  }
  .tab:hover {
    background: #e2e8f0;
    transform: translateY(-2px);
  }
  .tab.active {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: var(--white);
    box-shadow: var(--shadow);
  }
  .tab.active::after {
    content: '';
    position: absolute;
    bottom: -12px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 8px solid var(--primary-dark);
  }
  .panel {
    background: var(--white);
    padding: 24px;
    border-radius: 12px;
    box-shadow: var(--shadow-lg);
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
  }
  .card {
    background: var(--white);
    padding: 20px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease;
  }
  .card:hover {
    transform: translateY(-4px);
  }
  .card h3 {
    color: var(--primary-dark);
    margin-bottom: 16px;
    font-size: 18px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--light-gray);
  }
  .card h4 {
    color: var(--primary);
    margin: 16px 0 12px 0;
    font-size: 16px;
  }
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 20px;
  }
  .stat-item {
    background: var(--white);
    padding: 16px;
    border-radius: 8px;
    box-shadow: var(--shadow);
    text-align: center;
    transition: transform 0.3s ease;
  }
  .stat-item:hover {
    transform: translateY(-2px);
  }
  .stat-label {
    font-size: 12px;
    color: var(--gray);
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 8px;
  }
  .stat-value {
    font-size: 28px;
    font-weight: 800;
    color: var(--primary);
  }
  .top-countries-list {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 16px;
  }
  .country-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    margin-bottom: 8px;
    background: var(--white);
    border-radius: 8px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    border-left: 4px solid var(--primary);
  }
  .country-item:hover {
    background: #f8fafc;
    transform: translateX(4px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
  }
  .country-name {
    font-weight: 600;
    color: var(--dark);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .country-flag {
    font-size: 18px;
  }
  .country-count {
    font-weight: 700;
    color: var(--primary);
    font-size: 16px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    min-width: 40px;
    text-align: center;
  }
  .country-rank {
    background: var(--light-gray);
    color: var(--gray);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    margin-right: 8px;
  }
  #ip-bans, #fp-bans, #reported-list, #blocked-countries {
    max-height: 400px;
    overflow-y: auto;
    padding: 12px;
    background: var(--light-gray);
    border-radius: 8px;
  }
  #db-visitors-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
  }
  #db-visitors-table th, #db-visitors-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
  }
  #db-visitors-table th {
    background: var(--primary);
    color: white;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  #db-visitors-table tr:hover {
    background: #f8fafc;
  }
  #db-visitors-table tbody tr:nth-child(even) {
    background: #f9fafb;
  }
  .page-info {
    margin-top: 12px;
    font-size: 14px;
    color: var(--gray);
  }
  button {
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
    color: var(--white);
  }
  button:hover {
    transform: scale(1.05);
    opacity: 0.9;
  }
  .unban { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); }
  .ban { background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); }
  .broadcast { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); }
  .clear { background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%); }
  .export-btn { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
  textarea {
    width: 100%;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    font-family: inherit;
    font-size: 14px;
    transition: border-color 0.3s;
  }
  textarea:focus {
    outline: none;
    border-color: var(--primary);
  }
  .country-list {
    max-height: 500px;
    overflow-y: auto;
  }
  .flex {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }
  .rep-card {
    padding: 16px;
    border-left: 4px solid var(--primary);
    border-radius: 8px;
    margin-bottom: 12px;
    background: var(--light-gray);
    transition: all 0.3s ease;
  }
  .rep-card:hover {
    box-shadow: var(--shadow);
    border-left-color: var(--danger);
  }
  .charts-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 24px;
  }
  .chart-container {
    position: relative;
    height: 400px;
    width: 100%;
  }
  .stats-country-list {
    max-height: 300px;
    overflow-y: auto;
    padding: 12px;
    background: var(--light-gray);
    border-radius: 8px;
  }
  @media (max-width: 768px) {
    .charts-container, .dashboard-grid {
      grid-template-columns: 1fr;
    }
    .topbar {
      overflow-x: auto;
    }
    .stats-grid {
      grid-template-columns: 1fr;
    }
    .chart-container {
      height: 300px;
    }
  }
</style>
<base target="_blank">
</head>
<body>
<h1>ğŸ“Š Admin Live Dashboard</h1>
<div class="topbar" id="tabs">
  <div class="tab active" data-tab="dashboard">ğŸ“ˆ Dashboard</div>
  <div class="tab" data-tab="countries">ğŸŒ Countries</div>
  <div class="tab" data-tab="stats">ğŸ“Š Statistics</div>
  <div class="tab" data-tab="reports">ğŸš¨ Reports</div>
  <div class="tab" data-tab="bans">âš ï¸ Bans</div>
  <div class="tab" data-tab="dbvisitors">ğŸ—„ï¸ Ø²ÙˆØ§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
  <div style="margin-left:auto;color:var(--gray);font-size:14px;font-weight:600">ğŸ‘¤ Admin Mode</div>
</div>

<div id="content">
  <!-- Dashboard Panel -->
  <div class="panel" id="panel-dashboard">
    <div class="dashboard-grid">
      <div class="card">
        <h3>ğŸ“¡ Live Statistics</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-label">Connected Users</div>
            <span id="stat-connected" class="stat-value">0</span>
          </div>
          <div class="stat-item">
            <div class="stat-label">Waiting</div>
            <span id="stat-waiting" class="stat-value">0</span>
          </div>
          <div class="stat-item">
            <div class="stat-label">Paired</div>
            <span id="stat-partnered" class="stat-value">0</span>
          </div>
          <div class="stat-item">
            <div class="stat-label">Total Visitors (DB)</div>
            <span id="stat-totalvisitors" class="stat-value">0</span>
          </div>
        </div>
        <h4>ğŸŒ Top Countries</h4>
        <div id="country-list" class="top-countries-list"></div>
      </div>

      <div class="card">
        <h3>ğŸ“¢ Broadcast Message</h3>
        <form id="broadcastForm">
          <textarea id="broadcastMsg" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†..."></textarea><br><br>
          <button type="submit" class="broadcast">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
        </form>
      </div>

      <div class="card">
        <h3>ğŸš« Active Bans</h3>
        <h4>IP Bans</h4>
        <div id="ip-bans"></div>
        <h4 style="margin-top:16px">Device Bans</h4>
        <div id="fp-bans"></div>
      </div>

      <div class="card">
        <h3>ğŸš¨ Reported Users</h3>
        <div id="reported-list"></div>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <h3>ğŸ—„ï¸ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ø¯Ø§Ø¦Ù…Ø© (Ù„Ø§ ØªÙØ­Ø°Ù Ø£Ø¨Ø¯Ù‹Ø§)</h3>
        <div style="margin-bottom:12px;">
          <button id="export-csv" class="export-btn">ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙƒÙ€ CSV</button>
          <button id="export-json" class="export-btn" style="margin-left:8px;background:#f59e0b">ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙƒÙ€ JSON</button>
        </div>
        <table id="db-visitors-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
              <th>IP</th>
              <th>Ø§Ù„Ø¯ÙˆÙ„Ø©</th>
              <th>Fingerprint (Ø£ÙˆÙ„ 12 Ø­Ø±Ù)</th>
            </tr>
          </thead>
          <tbody id="db-visitors-body"></tbody>
        </table>
        <div class="page-info" id="db-page-info">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
    </div>
  </div>

  <!-- Countries Panel -->
  <div class="panel" id="panel-countries" style="display:none">
    <h2>ğŸŒ Country Management</h2>
    <div style="display:grid;grid-template-columns:1fr 320px;gap:24px">
      <div>
        <h3>All Countries</h3>
        <div class="country-list" id="all-countries"></div>
      </div>
      <div>
        <div class="card">
          <h4>ğŸ”’ Blocked Countries</h4>
          <div id="blocked-countries"></div>
          <button id="clear-blocks" class="clear" style="width:100%;margin-top:16px">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¸Ø±</button>
        </div>
      </div>
    </div>
    <div style="margin-top:16px;background:#fff3cd;padding:12px;border-radius:8px;color:#856404;">
      ğŸ’¡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø­Ø¸Ø± Ø³ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© "Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¸ÙˆØ± ÙÙŠ Ø¨Ù„Ø¯Ùƒ" Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆÙ„ ÙÙˆØ± Ø§ØªØµØ§Ù„Ù‡Ù….
    </div>
  </div>

  <!-- Stats Panel -->
  <div class="panel" id="panel-stats" style="display:none">
    <h2>ğŸ“Š Visitors Analytics</h2>
    <div class="charts-container">
      <div class="card">
        <h3>Daily Visitors Trend</h3>
        <div class="chart-container">
          <canvas id="visitorsChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3>Top Countries</h3>
        <div id="stats-country-list" class="stats-country-list"></div>
        <h4 style="margin-top:24px">ğŸ“… Date Range</h4>
        <div style="display:flex;flex-direction:column;gap:12px">
          <label><span class="small">Ù…Ù†</span><input type="date" id="fromDate"></label>
          <label><span class="small">Ø¥Ù„Ù‰</span><input type="date" id="toDate"></label>
          <button id="refreshStats" class="broadcast" style="width:100%">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Reports Panel -->
  <div class="panel" id="panel-reports" style="display:none">
    <h2>ğŸš¨ User Reports</h2>
    <div id="reports-panel"></div>
  </div>

  <!-- Bans Panel -->
  <div class="panel" id="panel-bans" style="display:none">
    <h2>âš ï¸ Ban Management</h2>
    <div id="bans-panel"></div>
  </div>

  <!-- Database Visitors Full Panel -->
  <div class="panel" id="panel-dbvisitors" style="display:none">
    <h2>ğŸ—„ï¸ Ø¬Ù…ÙŠØ¹ Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¯Ø§Ø¦Ù…Ø© - Ù„Ø§ ØªÙØ­Ø°Ù Ø£Ø¨Ø¯Ù‹Ø§)</h2>
    <div style="margin-bottom:16px;">
      <button id="export-all-csv" class="export-btn">ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒÙ„ ÙƒÙ€ CSV</button>
      <button id="export-all-json" class="export-btn" style="margin-left:8px;background:#f59e0b">ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒÙ„ ÙƒÙ€ JSON</button>
    </div>
    <table style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th style="background:var(--primary);color:white;padding:12px">#</th>
          <th style="background:var(--primary);color:white;padding:12px">Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
          <th style="background:var(--primary);color:white;padding:12px">IP</th>
          <th style="background:var(--primary);color:white;padding:12px">Ø§Ù„Ø¯ÙˆÙ„Ø©</th>
          <th style="background:var(--primary);color:white;padding:12px">Fingerprint</th>
        </tr>
      </thead>
      <tbody id="db-all-body"></tbody>
    </table>
    <div class="page-info" id="db-all-info">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  </div>
</div>

<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const socket = io();
  socket.emit('admin-join');
  socket.on('connect', () => socket.emit('admin-join'));

  // Tabs
  document.querySelectorAll('.tab').forEach(t => {
    t.onclick = () => {
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const tab = t.dataset.tab;
      document.querySelectorAll('[id^=panel-]').forEach(p=>p.style.display='none');
      document.getElementById('panel-' + tab).style.display = 'block';
      if (tab === 'countries') loadCountries();
      if (tab === 'stats') loadStats();
      if (tab === 'dbvisitors') loadAllDbVisitors();
    };
  });

  // Live Snapshot Update
  function renderSnapshot(snap) {
    document.getElementById('stat-connected').textContent = snap.stats.connected || 0;
    document.getElementById('stat-waiting').textContent = snap.stats.waiting || 0;
    document.getElementById('stat-partnered').textContent = snap.stats.partnered || 0;
    document.getElementById('stat-totalvisitors').textContent = snap.stats.totalVisitors || 0;

    // Top Countries
    const cl = document.getElementById('country-list');
    cl.innerHTML = '';
    const entries = Object.entries(snap.stats.countryCounts || {});
    if (entries.length === 0) {
      cl.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª';
    } else {
      entries.sort((a,b)=>b[1]-a[1]);
      const topN = 15;
      const toShow = entries.slice(0, topN);
      toShow.forEach(([country, cnt], index) => {
        const d = document.createElement('div');
        d.className = 'country-item';
        const rank = document.createElement('span');
        rank.className = 'country-rank';
        rank.textContent = `#${index + 1}`;
        const nameDiv = document.createElement('div');
        nameDiv.className = 'country-name';
        const flag = document.createElement('span');
        flag.className = 'country-flag';
        flag.textContent = getCountryFlag(country);
        const name = document.createElement('span');
        name.textContent = country;
        nameDiv.appendChild(rank);
        nameDiv.appendChild(flag);
        nameDiv.appendChild(name);
        const count = document.createElement('span');
        count.className = 'country-count';
        count.textContent = cnt;
        d.appendChild(nameDiv);
        d.appendChild(count);
        cl.appendChild(d);
      });
    }

    // IP Bans
    const ipb = document.getElementById('ip-bans');
    ipb.innerHTML = snap.activeIpBans.length ? '' : '<div style="color:var(--gray)">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¸Ø± IP Ù†Ø´Ø·</div>';
    snap.activeIpBans.forEach(b => {
      const div = document.createElement('div');
      div.style.padding = '8px';
      div.style.marginBottom = '8px';
      div.style.background = 'rgba(239, 68, 68, 0.1)';
      div.style.borderRadius = '6px';
      div.innerHTML = `<b style="color:var(--danger)">${b.ip}</b><br><small>ÙŠÙ†ØªÙ‡ÙŠ: ${new Date(b.expires).toLocaleString()}</small> `;
      const btn = document.createElement('button');
      btn.textContent = 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±'; btn.className = 'unban';
      btn.style.padding = '6px 10px';
      btn.onclick = () => fetch('/unban-ip', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ip:b.ip})});
      div.appendChild(btn);
      ipb.appendChild(div);
    });

    // Fingerprint Bans
    const fpb = document.getElementById('fp-bans');
    fpb.innerHTML = snap.activeFpBans.length ? '' : '<div style="color:var(--gray)">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¸Ø± Ø¬Ù‡Ø§Ø² Ù†Ø´Ø·</div>';
    snap.activeFpBans.forEach(b => {
      const div = document.createElement('div');
      div.style.padding = '8px';
      div.style.marginBottom = '8px';
      div.style.background = 'rgba(239, 68, 68, 0.1)';
      div.style.borderRadius = '6px';
      div.innerHTML = `<b style="color:var(--danger)">${b.fp}</b><br><small>ÙŠÙ†ØªÙ‡ÙŠ: ${new Date(b.expires).toLocaleString()}</small> `;
      const btn = document.createElement('button');
      btn.textContent = 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±'; btn.className = 'unban';
      btn.style.padding = '6px 10px';
      btn.onclick = () => fetch('/unban-fingerprint', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({fp:b.fp})});
      div.appendChild(btn);
      fpb.appendChild(div);
    });

    // Reported Users
    const rep = document.getElementById('reported-list');
    rep.innerHTML = snap.reportedUsers.length ? '' : '<div style="color:var(--gray)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª</div>';
    snap.reportedUsers.forEach(r => {
      const div = document.createElement('div'); div.className = 'rep-card';
      if (r.screenshot) {
        const img = document.createElement('img');
        img.src = r.screenshot; img.style.maxWidth = '160px'; img.style.marginRight = '16px'; img.style.borderRadius = '8px';
        const showBtn = document.createElement('button');
        showBtn.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©';
        showBtn.style.cssText = 'background:var(--primary);margin-top:8px;padding:6px';
        showBtn.onclick = () => {
          const w = window.open("", "_blank");
          w.document.write(`<meta charset="utf-8"><title>Ù„Ù‚Ø·Ø© Ø´Ø§Ø´Ø©</title><img src="${r.screenshot}" style="max-width:100%;display:block;margin:10px auto;">`);
        };
        div.appendChild(img); div.appendChild(showBtn);
      } else div.innerHTML += '<div style="color:var(--gray);margin-bottom:8px">ğŸ“· Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„Ù‚Ø·Ø© Ø´Ø§Ø´Ø©</div>';
      div.innerHTML += `<div style="margin-top:12px"><b>Ø§Ù„Ù…ÙØ¨Ù„Ù‘ÙØº Ø¹Ù†Ù‡:</b> ${r.target}<br><b>Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª:</b> <span style="color:var(--danger)">${r.count}</span></div>`;
      const small = document.createElement('div'); small.style.cssText = 'font-size:12px;color:var(--gray);margin-top:8px';
      small.textContent = 'Ø§Ù„Ù…ÙØ¨Ù„Ù‘ÙØºÙˆÙ†: ' + (r.reporters.length ? r.reporters.join(', ') : 'â€”');
      div.appendChild(small);
      const btnWrap = document.createElement('div'); btnWrap.style.marginTop = '12px'; btnWrap.style.display = 'flex'; btnWrap.style.gap = '8px';
      const banBtn = document.createElement('button'); banBtn.textContent = 'Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'; banBtn.className = 'ban';
      banBtn.onclick = () => {
        if (!confirm(`Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${r.target}ØŸ`)) return;
        fetch('/manual-ban', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ target: r.target })}).then(()=>{});
      };
      const removeBtn = document.createElement('button'); removeBtn.textContent = 'Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù„Ø§Øº';
      removeBtn.style.cssText = 'background:var(--gray)';
      removeBtn.onclick = () => {
        if (!confirm(`Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù„Ø§Øº Ø¹Ù† ${r.target}ØŸ`)) return;
        fetch('/remove-report', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ target: r.target })}).then(()=>{});
      };
      btnWrap.appendChild(banBtn); btnWrap.appendChild(removeBtn); div.appendChild(btnWrap);
      rep.appendChild(div);
    });

    // Blocked Countries (ÙÙŠ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯)
    const bc = document.getElementById('blocked-countries');
    if (bc) {
      bc.innerHTML = snap.bannedCountries.length ? '' : '<div style="color:var(--gray)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆÙ„ Ù…Ø­Ø¸ÙˆØ±Ø©</div>';
      snap.bannedCountries.forEach(c => {
        const d = document.createElement('div');
        d.style.padding = '8px'; d.style.marginBottom = '6px';
        d.style.background = 'rgba(239, 68, 68, 0.1)'; d.style.borderRadius = '6px';
        d.innerHTML = `<b>${c}</b> â€” ${COUNTRY_NAME(c)}`;
        bc.appendChild(d);
      });
    }
  }
  socket.on('adminUpdate', renderSnapshot);

  // Broadcast
  document.getElementById('broadcastForm').onsubmit = e => {
    e.preventDefault();
    const msg = document.getElementById('broadcastMsg').value.trim();
    if (!msg) return;
    fetch('/admin-broadcast', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message: msg})}).then(()=>{});
    document.getElementById('broadcastMsg').value = '';
  };

  // Country Flags
  function getCountryFlag(countryCode) {
    const flagMap = {
      'US': 'ğŸ‡ºğŸ‡¸', 'GB': 'ğŸ‡¬ğŸ‡§', 'FR': 'ğŸ‡«ğŸ‡·', 'DE': 'ğŸ‡©ğŸ‡ª', 'IT': 'ğŸ‡®ğŸ‡¹', 'ES': 'ğŸ‡ªğŸ‡¸',
      'CA': 'ğŸ‡¨ğŸ‡¦', 'AU': 'ğŸ‡¦ğŸ‡º', 'JP': 'ğŸ‡¯ğŸ‡µ', 'KR': 'ğŸ‡°ğŸ‡·', 'CN': 'ğŸ‡¨ğŸ‡³', 'IN': 'ğŸ‡®ğŸ‡³',
      'BR': 'ğŸ‡§ğŸ‡·', 'RU': 'ğŸ‡·ğŸ‡º', 'MX': 'ğŸ‡²ğŸ‡½', 'AR': 'ğŸ‡¦ğŸ‡·', 'ZA': 'ğŸ‡¿ğŸ‡¦', 'EG': 'ğŸ‡ªğŸ‡¬',
      'TR': 'ğŸ‡¹ğŸ‡·', 'IR': 'ğŸ‡®ğŸ‡·', 'TH': 'ğŸ‡¹ğŸ‡­', 'VN': 'ğŸ‡»ğŸ‡³', 'PH': 'ğŸ‡µğŸ‡­', 'MY': 'ğŸ‡²ğŸ‡¾',
      'SG': 'ğŸ‡¸ğŸ‡¬', 'ID': 'ğŸ‡®ğŸ‡©', 'BD': 'ğŸ‡§ğŸ‡©', 'PK': 'ğŸ‡µğŸ‡°', 'NG': 'ğŸ‡³ğŸ‡¬', 'KE': 'ğŸ‡°ğŸ‡ª',
      'SA': 'ğŸ‡¸ğŸ‡¦', 'AE': 'ğŸ‡¦ğŸ‡ª', 'IL': 'ğŸ‡®ğŸ‡±', 'UA': 'ğŸ‡ºğŸ‡¦', 'PL': 'ğŸ‡µğŸ‡±', 'SE': 'ğŸ‡¸ğŸ‡ª',
      'NO': 'ğŸ‡³ğŸ‡´', 'DK': 'ğŸ‡©ğŸ‡°', 'FI': 'ğŸ‡«ğŸ‡®', 'NL': 'ğŸ‡³ğŸ‡±', 'BE': 'ğŸ‡§ğŸ‡ª', 'CH': 'ğŸ‡¨ğŸ‡­',
      'AT': 'ğŸ‡¦ğŸ‡¹', 'CZ': 'ğŸ‡¨ğŸ‡¿', 'HU': 'ğŸ‡­ğŸ‡º', 'RO': 'ğŸ‡·ğŸ‡´', 'BG': 'ğŸ‡§ğŸ‡¬', 'HR': 'ğŸ‡­ğŸ‡·',
      'RS': 'ğŸ‡·ğŸ‡¸', 'SK': 'ğŸ‡¸ğŸ‡°', 'SI': 'ğŸ‡¸ğŸ‡®', 'LT': 'ğŸ‡±ğŸ‡¹', 'LV': 'ğŸ‡±ğŸ‡»', 'EE': 'ğŸ‡ªğŸ‡ª',
      'IE': 'ğŸ‡®ğŸ‡ª', 'PT': 'ğŸ‡µğŸ‡¹', 'GR': 'ğŸ‡¬ğŸ‡·', 'CY': 'ğŸ‡¨ğŸ‡¾', 'MT': 'ğŸ‡²ğŸ‡¹', 'LU': 'ğŸ‡±ğŸ‡º'
    };
    return flagMap[countryCode] || 'ğŸŒ';
  }

  // All Countries List
  const ALL_COUNTRIES = {
    "AF":"Afghanistan","AL":"Albania","DZ":"Algeria","AS":"American Samoa","AD":"Andorra","AO":"Angola","AI":"Anguilla",
    "AQ":"Antarctica","AG":"Antigua and Barbuda","AR":"Argentina","AM":"Armenia","AW":"Aruba","AU":"Australia","AT":"Austria",
    "AZ":"Azerbaijan","BS":"Bahamas","BH":"Bahrain","BD":"Bangladesh","BB":"Barbados","BY":"Belarus","BE":"Belgium","BZ":"Belize",
    "BJ":"Benin","BM":"Bermuda","BT":"Bhutan","BO":"Bolivia","BA":"Bosnia and Herzegovina","BW":"Botswana","BR":"Brazil",
    "IO":"British Indian Ocean Territory","VG":"British Virgin Islands","BN":"Brunei","BG":"Bulgaria","BF":"Burkina Faso",
    "BI":"Burundi","CV":"Cabo Verde","KH":"Cambodia","CM":"Cameroon","CA":"Canada","KY":"Cayman Islands","CF":"Central African Republic",
    "TD":"Chad","CL":"Chile","CN":"China","CX":"Christmas Island","CC":"Cocos (Keeling) Islands","CO":"Colombia","KM":"Comoros",
    "CG":"Congo - Brazzaville","CD":"Congo - Kinshasa","CK":"Cook Islands","CR":"Costa Rica","CI":"CÃ´te d'Ivoire","HR":"Croatia",
    "CU":"Cuba","CW":"CuraÃ§ao","CY":"Cyprus","CZ":"Czechia","DK":"Denmark","DJ":"Djibouti","DM":"Dominica","DO":"Dominican Republic",
    "EC":"Ecuador","EG":"Egypt","SV":"El Salvador","GQ":"Equatorial Guinea","ER":"Eritrea","EE":"Estonia","ET":"Ethiopia",
    "FK":"Falkland Islands","FO":"Faroe Islands","FJ":"Fiji","FI":"Finland","FR":"France","GF":"French Guiana","PF":"French Polynesia",
    "GA":"Gabon","GM":"Gambia","GE":"Georgia","DE":"Germany","GH":"Ghana","GI":"Gibraltar","GR":"Greece","GL":"Greenland","GD":"Grenada",
    "GP":"Guadeloupe","GU":"Guam","GT":"Guatemala","GG":"Guernsey","GN":"Guinea","GW":"Guinea-Bissau","GY":"Guyana","HT":"Haiti",
    "HN":"Honduras","HK":"Hong Kong","HU":"Hungary","IS":"Iceland","IN":"India","ID":"Indonesia","IR":"Iran","IQ":"Iraq","IE":"Ireland",
    "IM":"Isle of Man","IL":"Israel","IT":"Italy","JM":"Jamaica","JP":"Japan","JE":"Jersey","JO":"Jordan","KZ":"Kazakhstan","KE":"Kenya",
    "KI":"Kiribati","XK":"Kosovo","KW":"Kuwait","KG":"Kyrgyzstan","LA":"Laos","LV":"Latvia","LB":"Lebanon","LS":"Lesotho","LR":"Liberia",
    "LY":"Libya","LI":"Liechtenstein","LT":"Lithuania","LU":"Luxembourg","MO":"Macao","MK":"North Macedonia","MG":"Madagascar","MW":"Malawi",
    "MY":"Malaysia","MV":"Maldives","ML":"Mali","MT":"Malta","MH":"Marshall Islands","MQ":"Martinique","MR":"Mauritania","MU":"Mauritius",
    "YT":"Mayotte","MX":"Mexico","FM":"Micronesia","MD":"Moldova","MC":"Monaco","MN":"Mongolia","ME":"Montenegro","MS":"Montserrat",
    "MA":"Morocco","MZ":"Mozambique","MM":"Myanmar","NA":"Namibia","NR":"Nauru","NP":"Nepal","NL":"Netherlands","NC":"New Caledonia",
    "NZ":"New Zealand","NI":"Nicaragua","NE":"Niger","NG":"Nigeria","NU":"Niue","KP":"North Korea","MP":"Northern Mariana Islands","NO":"Norway",
    "OM":"Oman","PK":"Pakistan","PW":"Palau","PS":"Palestine","PA":"Panama","PG":"Papua New Guinea","PY":"Paraguay","PE":"Peru","PH":"Philippines",
    "PL":"Poland","PT":"Portugal","PR":"Puerto Rico","QA":"Qatar","RE":"RÃ©union","RO":"Romania","RU":"Russia","RW":"Rwanda","WS":"Samoa",
    "SM":"San Marino","ST":"SÃ£o TomÃ© & PrÃ­ncipe","SA":"Saudi Arabia","SN":"Senegal","RS":"Serbia","SC":"Seychelles","SL":"Sierra Leone",
    "SG":"Singapore","SX":"Sint Maarten","SK":"Slovakia","SI":"Slovenia","SB":"Solomon Islands","SO":"Somalia","ZA":"South Africa","KR":"South Korea",
    "SS":"South Sudan","ES":"Spain","LK":"Sri Lanka","BL":"St. BarthÃ©lemy","SH":"St. Helena","KN":"St. Kitts & Nevis","LC":"St. Lucia","MF":"St. Martin",
    "PM":"St. Pierre & Miquelon","VC":"St. Vincent & the Grenadines","SD":"Sudan","SR":"Suriname","SJ":"Svalbard & Jan Mayen","SE":"Sweden","CH":"Switzerland",
    "SY":"Syria","TW":"Taiwan","TJ":"Tajikistan","TZ":"Tanzania","TH":"Thailand","TL":"Timor-Leste","TG":"Togo","TK":"Tokelau","TO":"Tonga",
    "TT":"Trinidad & Tobago","TN":"Tunisia","TR":"Turkey","TM":"Turkmenistan","TC":"Turks & Caicos Islands","TV":"Tuvalu","UG":"Uganda","UA":"Ukraine",
    "AE":"United Arab Emirates","GB":"United Kingdom","US":"United States","UY":"Uruguay","UZ":"Uzbekistan","VU":"Vanuatu","VA":"Vatican City",
    "VE":"Venezuela","VN":"Vietnam","VI":"U.S. Virgin Islands","WF":"Wallis & Futuna","EH":"Western Sahara","YE":"Yemen","ZM":"Zambia","ZW":"Zimbabwe"
  };

  function COUNTRY_NAME(code){ return ALL_COUNTRIES[code] || code; }

  // Countries Management
  async function loadCountries() {
    const res = await fetch('/admin/countries-list');
    const data = await res.json();
    const banned = new Set(data.banned || []);
    const container = document.getElementById('all-countries');
    container.innerHTML = '';
    const codes = Object.keys(ALL_COUNTRIES).sort((a,b)=>ALL_COUNTRIES[a].localeCompare(ALL_COUNTRIES[b]));
    codes.forEach(code => {
      const div = document.createElement('div'); div.className='country-item';
      const left = document.createElement('div'); left.className='flex';
      const checkbox = document.createElement('input'); checkbox.type='checkbox'; checkbox.checked = banned.has(code);
      checkbox.dataset.code = code;
      const label = document.createElement('div'); label.textContent = code + ' â€” ' + ALL_COUNTRIES[code];
      left.appendChild(checkbox); left.appendChild(label);
      const action = document.createElement('div');
      const btn = document.createElement('button'); btn.textContent = checkbox.checked ? 'ğŸŸ¢ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±' : 'ğŸ”´ Ø­Ø¸Ø±';
      btn.style.background = checkbox.checked ? 'var(--success)' : 'var(--danger)'; btn.style.color='#fff';
      btn.onclick = async () => {
        const endpoint = checkbox.checked ? '/admin/unblock-country' : '/admin/block-country';
        await fetch(endpoint, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ code })}).then(()=>{});
        loadCountries();
      };
      action.appendChild(btn);
      div.appendChild(left); div.appendChild(action);
      container.appendChild(div);
    });
    document.getElementById('clear-blocks').onclick = async () => {
      if (!confirm('Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©ØŸ')) return;
      await fetch('/admin/clear-blocked', {method:'POST'}).then(()=>{});
      loadCountries();
    };
    const bc = document.getElementById('blocked-countries');
    bc.innerHTML = data.banned.length ? '' : '<div style="color:var(--gray)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆÙ„ Ù…Ø­Ø¸ÙˆØ±Ø©</div>';
    data.banned.forEach(c => {
      const d = document.createElement('div');
      d.style.padding = '8px'; d.style.marginBottom = '6px';
      d.style.background = 'rgba(239, 68, 68, 0.1)'; d.style.borderRadius = '6px';
      d.innerHTML = `<b>${c}</b> â€” ${COUNTRY_NAME(c)}`;
      bc.appendChild(d);
    });
  }

  // Charts
  let visitorsChart = null;
  async function loadStats() {
    const from = document.getElementById('fromDate').value;
    const to = document.getElementById('toDate').value;
    const params = new URLSearchParams();
    if (from) params.append('from', from);
    if (to) params.append('to', to);
    const res = await fetch('/admin/stats-data?' + params.toString());
    const data = await res.json();
    const ctx = document.getElementById('visitorsChart').getContext('2d');
    const labels = data.daily.map(d=>d.date);
    const values = data.daily.map(d=>d.count);
    if (visitorsChart) visitorsChart.destroy();
    visitorsChart = new Chart(ctx, {
      type:'line',
      data:{
        labels,
        datasets:[{
          label:'Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠÙˆÙ†',
          data:values,
          fill:true,
          tension:0.4,
          borderColor:'#4b6cb7',
          backgroundColor: 'rgba(75, 108, 183, 0.1)',
          pointRadius: 6,
          pointHoverRadius: 8,
          borderWidth: 3,
          pointBackgroundColor: '#fff',
          pointBorderColor: '#4b6cb7'
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        scales: {
          y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.03)' } },
          x: { grid: { color: 'rgba(0,0,0,0.03)' } }
        },
        plugins: {
          legend: { display: true, position: 'top', labels: { font: { size: 14 } } },
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: 'rgba(30, 41, 59, 0.9)',
            titleColor: '#fff',
            bodyColor: '#fff'
          }
        }
      }
    });

    const countryList = document.getElementById('stats-country-list');
    countryList.innerHTML = '';
    data.countries.forEach((country, index) => {
      const div = document.createElement('div');
      div.className = 'country-item';
      const rank = document.createElement('span');
      rank.className = 'country-rank';
      rank.textContent = `#${index + 1}`;
      const nameDiv = document.createElement('div');
      nameDiv.className = 'country-name';
      const flag = document.createElement('span');
      flag.className = 'country-flag';
      flag.textContent = getCountryFlag(country.country);
      const name = document.createElement('span');
      name.textContent = country.country;
      nameDiv.appendChild(rank);
      nameDiv.appendChild(flag);
      nameDiv.appendChild(name);
      const count = document.createElement('span');
      count.className = 'country-count';
      count.textContent = country.count;
      div.appendChild(nameDiv);
      div.appendChild(count);
      countryList.appendChild(div);
    });
  }
  document.getElementById('refreshStats').onclick = loadStats;

  // Database Visitors (Dashboard)
  const PAGE_SIZE = 100;
  let currentPage = 1;

  async function loadDbVisitors(page = 1) {
    currentPage = page;
    const res = await fetch(`/admin/db-visitors?page=${page}&limit=${PAGE_SIZE}`);
    const data = await res.json();

    document.getElementById('stat-totalvisitors').textContent = data.total;

    const tbody = document.getElementById('db-visitors-body');
    tbody.innerHTML = '';
    data.visitors.forEach((v, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${(page-1)*PAGE_SIZE + i + 1}</td>
        <td>${new Date(v.timestamp).toLocaleString('ar-EG')}</td>
        <td><b>${v.ip}</b></td>
        <td>${v.country || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'} ${getCountryFlag(v.country || '')}</td>
        <td>${v.fingerprint ? v.fingerprint.slice(0,12) + '...' : 'â€”'}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('db-page-info').textContent = 
      `Ø¹Ø±Ø¶ ${data.visitors.length} Ø³Ø¬Ù„ Ù…Ù† Ø£ØµÙ„ ${data.total} (ØµÙØ­Ø© ${page})`;
  }

  // Export current page
  document.getElementById('export-csv').onclick = async () => {
    const res = await fetch(`/admin/db-visitors?page=${currentPage}&limit=${PAGE_SIZE}&format=csv`);
    const blob = await res.blob();
    downloadFile(blob, `visitors-page-${currentPage}.csv`);
  };
  document.getElementById('export-json').onclick = async () => {
    const res = await fetch(`/admin/db-visitors?page=${currentPage}&limit=${PAGE_SIZE}&format=json`);
    const blob = await res.blob();
    downloadFile(blob, `visitors-page-${currentPage}.json`);
  };

  // Full DB Visitors Tab
  async function loadAllDbVisitors() {
    const tbody = document.getElementById('db-all-body');
    const info = document.getElementById('db-all-info');
    info.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
    tbody.innerHTML = '';

    const res = await fetch('/admin/db-visitors?all=true');
    const data = await res.json();

    data.visitors.forEach((v, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${new Date(v.timestamp).toLocaleString('ar-EG')}</td>
        <td>${v.ip}</td>
        <td>${v.country || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'} ${getCountryFlag(v.country || '')}</td>
        <td>${v.fingerprint || 'â€”'}</td>
      `;
      tbody.appendChild(tr);
    });

    info.textContent = `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${data.visitors.length} Ø²ÙŠØ§Ø±Ø© ÙƒØ§Ù…Ù„Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`;
  }

  document.getElementById('export-all-csv').onclick = async () => {
    const res = await fetch('/admin/db-visitors?all=true&format=csv');
    const blob = await res.blob();
    downloadFile(blob, 'all-visitors-permanent.csv');
  };
  document.getElementById('export-all-json').onclick = async () => {
    const res = await fetch('/admin/db-visitors?all=true&format=json');
    const blob = await res.blob();
    downloadFile(blob, 'all-visitors-permanent.json');
  };

  function downloadFile(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  // Initial loads
  loadDbVisitors(1);
  loadCountries();
  loadStats();
</script>
</body>
</html>
